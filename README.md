# HighloadEmail #

## Статистика из открытых источников ##

Исходя из данных [wikipedia](https://ru.wikipedia.org/wiki/Население_России) в России живет порядка 146 млн человек. [yandex.radar](https://radar.yandex.ru/yandex?month=2020-08) же говорит, что число уникальных пользователей Яндекс почты составляет около 17млн человек в месяц , в процентом соотношении это 11% населения страны. Сылаясь на [similarweb](https://www.similarweb.com/website/mail.yandex.ru/) у почты Яндекса общее количество посещений в месяц примерно 400млн(У почты Mail.ru - более 540млн), со средним временем нахождения пользователя на сайте - 8 минут. Общее количество активных аккаунтов почты mail.ru составляет [100млн](https://corp.mail.ru/ru/company/portal/) 
Лимит на объем одного письма без вложения сделаем равным 10MB. Есть возможность прикреплять файлы(вложения),максимальный объем вложений в сумме - 20MB

## Запросы ##

   -  Регистрация
   -  Авторизация
   -  Постраничное получение списка последних писем
   -  Отправка и пересылка писем
   -  Удаление писем
   -  Чтение писем
   -  Скачивание вложений из писем
   
## Средний пользователь ##

Предположим, что средний пользователь отправляет и получает по 5 писем в день(по статистике яндекса эти цифры в 2 раза меньше), а список писем получает 10 раз в день. Ссылаясь на [источник_1](https://habr.com/ru/company/yandex/blog/199432/) и [источник2](https://habr.com/ru/post/321756/) около 10% писем содержат вложения. При этом средний размер письма без вложения 4KB, а с ним 400КВ. Средний размер почтового ящика -  6000 писем, из которых 2000 были получены за последние 2 года(в терминологии S3 хранилищ будем считать, что это те данные, которые относятся к HotBox). Суточная аудитория Яндекс почты порядка [6.2 млн человек](https://radar.yandex.ru/yandex?month=2020-08), при этом каждый, в среднем остается на сайте около 8 минут(для простоты вычислений возьмем 5).

## Эксперимент ##

Вспоминая нашего усредненного пользователя, проведем эксперимент. Откроем в браузере вкладку network и смоделируем поведения нашего пользователя. получаем 500 запросов, сгенерированных пользователем.

## Нагрузка ##

Нагрузка общая, исходя из результатов эксперимента
       
    RPS = (6.2*10^6 * 500)/(24*60*60) ~ 36000
    
### Целевые цифры проекта ###

5 млн пользователей в день

80 млн активных аккаунтов (54% населения РФ, 80% [Mail.ru](https://corp.mail.ru/ru/))

     RPS = 30000(5000 - бэкенд, 20000 фронтенд/веб-сервер, 5000 - вспомогательные службы) запросов в секунду


## Логическа схема базы данных ##

![image](https://user-images.githubusercontent.com/47527934/115367169-9f20e480-a1ce-11eb-90a4-75c8aab0c4ad.png)

## Физическая схема базы данных ##

### User ###

id     | name          | surname      | birthday        | gender   | accountname | password    | phone
------ | ------------- | ------------ | --------------- | -------- | ----------- | ----------- | ------
bigint | varchar(20)   | varchar(20)  | timestamp:date  | boolean  | varchar(30) | varchar(32) | bigint

Итог: 126 байт на одного пользователя

### Letter ###

id     | sender  | receiver        | theme        | text              | date           | isRead  | folderId        | answerOn  | fileId          |
------ | ------- | --------------- | ------------ | ----------------- | -------------- | ------- | --------------- | --------- | --------------- |
bigint | bigint  | bigint array[5] | varchar(100) | varchar(11000000) | timestamp:date | boolean | bigint array[5] | bigint    | bigint array[5] |
                        

Итог: 11000252 байт на одного пользователя

### File ###

id     | name          | extension  | size | path
------ | ------------- | ---------- | ---- | -----------
bigint | varchar(20)   | varchar(8) | int  | varchar(20)

Итог: 60 байт на одного пользователя

### Folder ###

id     | name        | letterCount | userId
------ | ----------- | ----------- | -------
bigint | varchar(20) | int         | bigint

Итог: 40 байт на одного пользователя

