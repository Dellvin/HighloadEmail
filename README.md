# HighloadEmail #

## Статистика из открытых источников ##

Исходя из данных [wikipedia](https://ru.wikipedia.org/wiki/Население_России) в России живет порядка 146 млн человек. [yandex.radar](https://radar.yandex.ru/yandex?month=2020-08) же говорит, что число уникальных пользователей Яндекс почты составляет около 17млн человек в месяц , в процентом соотношении это 11% населения страны. Сылаясь на [similarweb](https://www.similarweb.com/website/mail.yandex.ru/) у почты Яндекса общее количество посещений в месяц примерно 400млн(У почты Mail.ru - более 540млн), со средним временем нахождения пользователя на сайте - 8 минут. Общее количество активных аккаунтов почты mail.ru составляет [100млн](https://corp.mail.ru/ru/company/portal/) 
Лимит на объем одного письма без вложения сделаем равным 10MB. Есть возможность прикреплять файлы(вложения),максимальный объем вложений в сумме - 20MB

## Запросы ##

   -  Регистрация
   -  Авторизация
   -  Постраничное получение списка последних писем
   -  Отправка и пересылка писем
   -  Удаление писем
   -  Чтение писем
   -  Скачивание вложений из писем
   
## Средний пользователь ##

Предположим, что средний пользователь отправляет и получает по 5 писем в день(по статистике яндекса эти цифры в 2 раза меньше), а список писем получает 10 раз в день. Ссылаясь на [источник_1](https://habr.com/ru/company/yandex/blog/199432/) и [источник2](https://habr.com/ru/post/321756/) около 10% писем содержат вложения. При этом средний размер письма без вложения 4KB, а с ним 400КВ. Средний размер почтового ящика -  6000 писем, из которых 2000 были получены за последние 2 года(в терминологии S3 хранилищ будем считать, что это те данные, которые относятся к HotBox). Суточная аудитория Яндекс почты порядка [6.2 млн человек](https://radar.yandex.ru/yandex?month=2020-08), при этом каждый, в среднем остается на сайте около 8 минут(для простоты вычислений возьмем 5).

## Эксперимент ##

Вспоминая нашего усредненного пользователя, проведем эксперимент. Откроем в браузере вкладку network и смоделируем поведения нашего пользователя. получаем 500 запросов, сгенерированных пользователем.

## Нагрузка ##

Нагрузка общая, исходя из результатов эксперимента
       
    RPS = (6.2*10^6 * 500)/(24*60*60) ~ 36000
    
### Целевые цифры проекта ###

5 млн пользователей в день

80 млн активных аккаунтов (54% населения РФ, 80% [Mail.ru](https://corp.mail.ru/ru/))

     RPS = 30000(5000 - бэкенд, 20000 фронтенд/веб-сервер, 5000 - вспомогательные службы) запросов в секунду

## Логическа схема базы данных ##

![image](https://user-images.githubusercontent.com/47527934/115372266-620b2100-a1d3-11eb-8054-ef3b80d34aeb.png)

## Физическая схема базы данных ##

### User ###

id     | name          | surname      | birthday        | gender   | accountname | password    | phone
------ | ------------- | ------------ | --------------- | -------- | ----------- | ----------- | ------
bigint | varchar(20)   | varchar(20)  | timestamp:date  | boolean  | varchar(30) | varchar(32) | bigint

Итог: 126 байт на одного пользователя

### Letter ###

id     | sender  | receiver        | theme        | text              | date           | isRead  | folderId        | answerOn  | fileId          |
------ | ------- | --------------- | ------------ | ----------------- | -------------- | ------- | --------------- | --------- | --------------- |
bigint | bigint  | bigint array[5] | varchar(100) | varchar(11000000) | timestamp:date | boolean | bigint array[5] | bigint    | bigint array[5] |
                        

Итог: 11000252 байт на одного пользователя

### File ###

id     | name          | extension  | size | path
------ | ------------- | ---------- | ---- | -----------
bigint | varchar(20)   | varchar(8) | int  | varchar(20)

Итог: 60 байт на одного пользователя

### Folder ###

id     | name        | letterCount | userId
------ | ----------- | ----------- | -------
bigint | varchar(20) | int         | bigint

Итог: 40 байт на одного пользователя

В качестве СУБД будет использоваться LevelDB. Для каждого пользователя на сервере с СУБД будет создана папка, в которой будут храниться все связанные с ним сущности(Иконки,письма,вложения,данные о папках).Это позволит получать сообщения пользователя, конкретно из его стораджа, а не из какой-то общей таблицы,в которой будет миллионы сообщений, что очень замедлит поиск.

Согласно пунктам 7 и 9 из benchmark При размере данных в 100B и 128MB кеша:

Random Reads - 137,231 ops/sec
Random Writes - 176,929 ops/sec
Batch Random Writes - 229,095 entries/sec

Рассмотрим разные нагрузки от различных типов запроса:
1) Получения списка последних писем (50 штук).Данные будут браться из отдельной таблицы коротких сообщений. Согласно исследованию, данный запрос будет весить примерно 23KB данных,без учета иконок почт отправителей( 1 и 2).Учитывая цифры для среднего пользователя из пункта 2, получаем:

       RPS: 5 000 000 * 10 / 24 * 60 * 60 ~ 600
       
       Передаваемый трафик: 5 000 000 * 10 * 23KB / 24 * 60 * 60 ~ 13800KB ~ 14MB
       
Получается, что для обработки получения списка писем хватит мощности одного сервера.
2) Чтение одного письма - согласно исследованию, средний вес одного письма(в конечной для клиента форме)

12KB без учета прикрепляемого файла.(3 и 4 ) Примем, что пользователь читает хотя бы 5 писем в день. Тогда получим:

       RPS: 5 000 000 * 5 / 24 * 60 * 60 ~ 290
       
       Передаваемый трафик: 5 000 000 * 5 * 12KB / 24 * 60 * 60 ~ 3480KB ~ 3,3MB
       
Для данной задачи мощности все того же одного сервера с LevelDB вполне достаточно.
3) Написание письма - согласно пункту 2 мы считаем, что средний вес письма без вложения- 4KB, а с вложением - 400KB.

       5 000 000 пользователей * 5 писем в день = 25 000 000 писем в день всего
       25 000 000 * 0,9 = 22 500 000 писем без вложений
       
       22 500 000 * 4Кб = 90 000 000Кб весят все письма за день =~ 85Гб
       
       RPS писем без вложения: 5 000 000 * 5 / 24 * 60 * 60 = 289 


       25 000 000 * 0,1 = 2 500 000 писем с вложениями
       
       2 500 000 * 400Кб =~ 953Гб весят письма с вложениями
       
       Вес вложений составляет 99% веса письма, тогда примем , что мы получаем 940Гб вложений в день.
       
       RPS писем c вложениями: 5 000 000 * 1 / 24 * 60 * 60 = 58 
 

Данные загружаются на сервер со скоростью записи жесткого диска, наша база записывает в себя по сути только снипетт на сохраняемый файл. 

Отдельно обсудим систему архивного хранения писем.База наших писем ожидается действительно огромной, поэтому эффективным решением будет разделение "горячих" и "холодных" данных.Согласно пункту 2 мы считаем данные "горячими" ,если с момента их добавление прошло не более 2 лет(шардирование по дате). В более быстрых хранилищах мы будем хранить эти свежие данные, а в более вместительных - более старые данные, потому с бизнес-точки зрения мы согласны с тем,что если пользователь требует старые данные,то он готов подождать чуть дольше.


Перенос писем из "горячих" серверов в "холодные" будет осуществляться отдельной группой серверов в течение года. По окончанию копирования данных сервер переноса просит сервер "горячих" данных удалить перенесенные сообщения.Данные можно переносить с реплик, чтоб не нагружать главные сервера. Назначить на это можно такие же сервера, как сервера бэкендом для работы с базой.    
       

## Технологический стек ## 

Бэкенд: Главным языком для серверной разработки будет выбран Golang, который позволяет быстро и эффективно писать код.В его основе лежит теоретическая модель CSP.

Scalling by adding more of the same

Golang UK Conference 2017 by Arne Claus
Она обеспечит хорошую масштабируемость Бэкенда, а также позволит избежать блокировок при конкурентном доступе. В основном код будет написан с использованием обширной стандартной библиотеки, роутером будет выбран fasthttp, который показывает наилучшие показатели производительности. Безусловно , нужно учитывать трудности со сборщиком мусора, который будет снижать производительность раз за какое-то △t времени.Поэтому необходимо будет учитывать не только среднюю производительность , но и ее нижнюю границу.

Фронтенд: Выбор CSS,HTML,TypeScript/JavaScript , как технологий для фронтенд составляющей проекта будет обусловлен их популярностью и изученностью годами.Для JavaScript существует уже огромное количество библиотек ,которые как и упрощают верстку, так и способны влиять на производительность кода.TypeScript способен и ускорить разработку из-за отлавливания ошибок при компиляции, и обезопасить наш будущий код от непредсказуемого поведения.

Протоколы: В данном проекте подразумевается использование https и http2 для связи клиента с бэкендом.Также будет реализована связь с помощью websocket протокола, для отображения новых пришедших пользователю сообщений(как пример) в режиме реального времени. Связь микросервисов на бэкенде будет осуществляться классическим для Golang'а способом - через GRPS+Protobuf, что является одним из самых эффективных способов общения как с точки зрения скорости, так и с точки зрения размера передаваемого трафика.

Еще раз распишем путь нашего запроса по шагам.Для примера возьмем написания письма с вложением. Пускай пользователь уже зарегистрирован.Рассматривать будем только позитивные сценарии.
1) Пользователь запрашивает наш сайт. Веб-сервер(о нем речь пойдет ниже) отдает ему необходимую статику,а потом перенаправляет запросы с заголовками на бэкенд.
2) Бэкенд просит Redis отдать ему id пользователя и сервер с его данными по cookie.Далее бэкенд сервер осуществляет соединение с БД по полученному адресу и запрашивает оттуда базовую информацию о пользователе.После получения отдает все обратно клиенту.
3) У клиента отобразилась стартовая страница со всеми данными.Он переходит в раздел написания письма.Создает его,прикрепляет файл и совершает отправку.
4) Отправка с вложениями по REST API методу отличается от отправки без вложения.Веб-сервер
отправляет запрос на бэкенд.
5) Бэкенд сообщений узнает у Redis'a в какой сервер БД направляется это сообщение и отправляет по этому адресу. 7) Сервер БД получает письма, сохраняет их в папку пользователя, записывает необходимую информацию об этом в levelDB.
